<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Map - In Between</title>
  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="styles/sidebar-styles.css">
  <style>
    .map-container {
      height: 1200px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin: 20px 0;
    }
    
    .map-controls {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    .map-controls label {
      font-weight: 500;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .map-controls select {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      color: #2d3748;
    }
    
    .map-legend {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #4a5568;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #38b2ac;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      margin-bottom: 20px;
      transition: background-color 0.2s;
    }
    
    .back-button:hover {
      background: #319795;
    }
    
    .info-panel {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .building-info {
      display: none;
      padding: 15px;
      margin-top: 10px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 4px solid #38b2ac;
    }
    
    .building-info h4 {
      margin: 0 0 8px 0;
      color: #2d3748;
      font-size: 16px;
    }
    
    .building-info p {
      margin: 0;
      color: #4a5568;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="main-layout">
    <aside class="sidebar">
      <a href="quiz.html" class="sidebar-quiz-btn">Take the activity quiz üìù</a>
      <h2>Navigation</h2>
      <ul class="category-list">
        <li><a href="index.html" style="color: inherit; text-decoration: none;">üè† Home</a></li>
        <li><a href="main.html" style="color: inherit; text-decoration: none;">üìã Activities</a></li>
        <li style="background: #f0f9ff; border-radius: 8px; padding: 8px;">üó∫Ô∏è Campus Map</li>
      </ul>
    </aside>

    <main class="main-content">
      <a href="main.html" class="back-button">
        ‚Üê Back to Activities
      </a>
      
      <h1>Campus <span style="color:#38b2ac;font-weight:bold;">Map</span></h1>
      <p style="color: #4a5568; margin-bottom: 20px;">
        Explore all Microsoft campus buildings and find your way around. Click on any building marker to see more information.
      </p>
      <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <p style="margin: 0; font-size: 14px; color: #4a5568;">
          <strong>üîë API Key Setup:</strong> To enable the interactive map, get a free Azure Maps key from 
          <a href="https://azure.microsoft.com/en-us/services/azure-maps/" target="_blank" style="color: #38b2ac;">Azure Maps</a> 
          and replace <code>YOUR_AZURE_MAPS_KEY</code> in the code. The building directory below works without an API key.
        </p>
      </div>

      <div class="map-controls">
        <label for="campus-filter">
          üè¢ Filter by Campus:
        </label>
        <select id="campus-filter">
          <option value="all">All Campuses</option>
          <option value="East">East Campus</option>
          <option value="West">West Campus</option>
          <option value="North">North Campus</option>
          <option value="RedWest">RedWest Campus</option>
        </select>
        
        <button id="map-style-toggle" style="padding: 8px 16px; background: #4F46E5; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;">
          ÔøΩÔ∏è Switch to Road View
        </button>
        
        <button id="center-map" style="padding: 8px 16px; background: #38b2ac; color: white; border: none; border-radius: 8px; cursor: pointer;">
          üéØ Center Map
        </button>
      </div>

      <div class="map-legend">
        <div class="legend-item">
          <div class="legend-color" style="background-color: #3B82F6;"></div>
          <span>East Campus</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #10B981;"></div>
          <span>West Campus</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #F59E0B;"></div>
          <span>North Campus</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #EF4444;"></div>
          <span>RedWest Campus</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: #8B5CF6;"></div>
          <span>Special Facilities</span>
        </div>
      </div>

      <div id="map" class="map-container"></div>

      <div class="info-panel">
        <h3>Building Information</h3>
        <p>Click on any building marker to see detailed information about that location.</p>
        <div id="building-info" class="building-info">
          <h4 id="building-name"></h4>
          <p id="building-details"></p>
        </div>
      </div>
    </main>
  </div>

  <script src="js/buildingData.js"></script>
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.css" type="text/css" />
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/3/atlas.min.js"></script>
  <script>
    let map;
    let datasource;
    let popup;

    // Campus color mapping
    const campusColors = {
      'East': '#3B82F6',
      'West': '#10B981',
      'North': '#F59E0B',
      'RedWest': '#EF4444',
      'Remote': '#8B5CF6'
    };

    function initMap() {
      try {
        // Initialize Azure Maps
        map = new atlas.Map('map', {
          center: [-122.1379, 47.6423],
          zoom: 15,
          view: 'Auto',
          
          // Add authentication details for Azure Maps
          // You can get a free key from: https://azure.microsoft.com/en-us/services/azure-maps/
          authOptions: {
            authType: 'subscriptionKey',
            subscriptionKey: 'API_KEY' // Replace with your Azure Maps key
            // For development/demo purposes, you can also use anonymous authentication:
            // authType: 'anonymous',
            // clientId: 'YOUR_CLIENT_ID'
          },
          
          style: 'satellite_road_labels'
        });

        // Wait for the map to be ready
        map.events.add('ready', () => {
          // Create data source for markers
          datasource = new atlas.source.DataSource();
          map.sources.add(datasource);

          // Create a popup
          popup = new atlas.Popup({
            pixelOffset: [0, -18],
            closeButton: false
          });

          // Create layers function to be reusable
          window.createMapLayers = function() {
            // Remove existing layers if they exist
            try {
              map.layers.remove('building-markers');
              map.layers.remove('building-labels');
            } catch (e) {
              // Layers don't exist yet
            }

            // Add bubble layer for markers
            const bubbleLayer = new atlas.layer.BubbleLayer(datasource, 'building-markers', {
              radius: 15,
              strokeColor: 'white',
              strokeWidth: 3,
              color: ['get', 'color'],
              opacity: 0.8
            });
            map.layers.add(bubbleLayer);

            // Add symbol layer for labels
            const symbolLayer = new atlas.layer.SymbolLayer(datasource, 'building-labels', {
              textOptions: {
                textField: ['get', 'name'],
                font: ['StandardFont-Bold'],
                size: 10,
                color: 'white',
                haloColor: 'black',
                haloWidth: 1,
                offset: [0, 1.5]
              }
            });
            map.layers.add(symbolLayer);
          };

          // Create initial layers
          createMapLayers();

          // Add click event for markers - moved here to ensure layers exist
          map.events.add('click', 'building-markers', (e) => {
            if (e.shapes && e.shapes.length > 0) {
              const properties = e.shapes[0].getProperties();
              
              // Find the building data
              const building = buildingData[properties.buildingId];
              if (building) {
                // Show popup
                popup.setOptions({
                  content: `
                    <div style="padding: 15px; max-width: 250px;">
                      <h4 style="margin: 0 0 10px 0; color: #2d3748;">${building.name}</h4>
                      <p style="margin: 0 0 10px 0; color: #4a5568; font-size: 14px;">
                        <strong>Campus:</strong> ${building.campus}<br>
                        <strong>Coordinates:</strong> ${building.lat.toFixed(6)}, ${building.lng.toFixed(6)}
                      </p>
                      <a href="main.html" style="color: #38b2ac; text-decoration: none; font-weight: 500;">
                        View Activities ‚Üí
                      </a>
                    </div>
                  `,
                  position: e.position
                });
                
                popup.open(map);
                
                // Update info panel
                showBuildingInfo(building);
              }
            }
          });

          // Change cursor when hovering over markers
          map.events.add('mouseenter', 'building-markers', () => {
            map.getCanvasContainer().style.cursor = 'pointer';
          });

          map.events.add('mouseleave', 'building-markers', () => {
            map.getCanvasContainer().style.cursor = 'grab';
          });

          createMarkers();
          setupEventListeners();
        });

      } catch (error) {
        console.warn('Azure Maps failed to load, using fallback map');
        initFallbackMap();
      }
    }

    function createMarkers() {
      console.log('createMarkers() called');
      console.log('buildingData:', buildingData);
      
      // Clear existing markers
      if (datasource) {
        datasource.clear();
      }

      const campusFilter = document.getElementById('campus-filter').value;
      console.log('Campus filter:', campusFilter);
      const features = [];

      Object.entries(buildingData).forEach(([buildingId, building]) => {
        if (campusFilter !== 'all' && building.campus !== campusFilter) {
          return; // Skip if not matching filter
        }

        console.log(`Creating marker for ${building.name} at ${building.lat}, ${building.lng}`);

        // Create a feature for each building
        const feature = new atlas.data.Feature(new atlas.data.Point([building.lng, building.lat]), {
          name: building.name,
          campus: building.campus,
          buildingId: buildingId,
          color: campusColors[building.campus] || '#FF0000',
          coordinates: `${building.lat.toFixed(6)}, ${building.lng.toFixed(6)}`
        });

        features.push(feature);
      });

      console.log(`Created ${features.length} features`);

      // Add all features to the data source
      if (datasource) {
        datasource.add(features);
        console.log('Features added to datasource');
      } else {
        console.error('Datasource is null!');
      }
    }

    function showBuildingInfo(building) {
      const infoDiv = document.getElementById('building-info');
      const nameElement = document.getElementById('building-name');
      const detailsElement = document.getElementById('building-details');
      
      nameElement.textContent = building.name;
      detailsElement.innerHTML = `
        <strong>Campus:</strong> ${building.campus} Campus<br>
        <strong>Location:</strong> ${building.lat.toFixed(6)}, ${building.lng.toFixed(6)}<br>
        <strong>Activities:</strong> Check the main activities page for what's available in this building.
      `;
      
      infoDiv.style.display = 'block';
    }

    function setupEventListeners() {
      // Campus filter
      document.getElementById('campus-filter').addEventListener('change', createMarkers);

      // Map style toggle button
      let currentStyle = 'satellite_road_labels';
      const styleButton = document.getElementById('map-style-toggle');
      
      styleButton.addEventListener('click', () => {
        console.log('Style toggle clicked, current style:', currentStyle);
        if (map) {
          // Add event listener for style change completion
          const onStyleChange = () => {
            console.log('Style changed, recreating layers and markers');
            if (window.createMapLayers) {
              createMapLayers();
            }
            createMarkers();
            map.events.remove('styledata', onStyleChange);
          };

          map.events.add('styledata', onStyleChange);

          if (currentStyle === 'satellite_road_labels') {
            console.log('Switching to road view');
            map.setStyle({ style: 'road' });
            currentStyle = 'road';
            styleButton.innerHTML = 'üõ∞Ô∏è Switch to Satellite';
          } else {
            console.log('Switching to satellite view');
            map.setStyle({ style: 'satellite_road_labels' });
            currentStyle = 'satellite_road_labels';
            styleButton.innerHTML = 'üó∫Ô∏è Switch to Road View';
          }
        } else {
          console.error('Map is not initialized');
        }
      });

      // Center map button
      document.getElementById('center-map').addEventListener('click', () => {
        if (map) {
          map.setCamera({
            center: [-122.1379, 47.6423],
            zoom: 15
          });
        }
      });

    }

    function initFallbackMap() {
      // Fallback interactive map using basic HTML/CSS
      const mapDiv = document.getElementById('map');
      const campusFilter = document.getElementById('campus-filter');
      
      function renderFallbackMap() {
        const filterValue = campusFilter.value;
        const filteredBuildings = Object.entries(buildingData).filter(([id, building]) => 
          filterValue === 'all' || building.campus === filterValue
        );

        mapDiv.innerHTML = `
          <div style="padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center;">
            <h3 style="margin: 0 0 30px 0; font-size: 28px;">üìç Campus Buildings</h3>
            <p style="margin-bottom: 30px; font-size: 16px; opacity: 0.9;">
              Interactive map requires Azure Maps API key. For now, browse buildings below:
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; max-height: 1000px; overflow-y: auto; padding: 20px;">
              ${filteredBuildings.map(([id, building]) => `
                <div onclick="showBuildingInfo(${JSON.stringify(building).replace(/"/g, '&quot;')})" style="
                  background: white; 
                  color: #2d3748; 
                  padding: 20px; 
                  border-radius: 12px; 
                  cursor: pointer; 
                  transition: transform 0.2s, box-shadow 0.2s;
                  border-left: 5px solid ${campusColors[building.campus] || '#6B7280'};
                  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 12px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)'">
                  <h4 style="margin: 0 0 10px 0; font-size: 18px; color: #1a202c;">${building.name}</h4>
                  <p style="margin: 0; font-size: 14px; color: #4a5568; line-height: 1.5;">
                    <strong style="color: ${campusColors[building.campus] || '#6B7280'};">${building.campus} Campus</strong><br>
                    <span style="font-family: monospace; font-size: 12px;">${building.lat.toFixed(4)}, ${building.lng.toFixed(4)}</span>
                  </p>
                </div>
              `).join('')}
            </div>
            <p style="margin-top: 30px; font-size: 14px; opacity: 0.8;">
              Click on any building card to see more details in the information panel below.
            </p>
          </div>
        `;
      }

      renderFallbackMap();
      
      // Update fallback map when filter changes
      campusFilter.addEventListener('change', renderFallbackMap);
      
      // Update center button for fallback
      document.getElementById('center-map').addEventListener('click', () => {
        mapDiv.scrollIntoView({ behavior: 'smooth' });
      });
    }

    // Initialize map when page loads
    window.addEventListener('load', () => {
      // Try to initialize Azure Maps
      if (typeof atlas !== 'undefined') {
        initMap();
      } else {
        // If Azure Maps doesn't load, show fallback
        setTimeout(initFallbackMap, 1000);
      }
    });

    // Global function for fallback map clicks
    window.showBuildingInfo = showBuildingInfo;
  </script>
</body>
</html>
